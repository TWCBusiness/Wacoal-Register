<script>
    async function main() {
        const myLiffId = "2008993053-zdStgsKn"; 
        const scriptUrl = "https://script.google.com/macros/s/AKfycbx77RW1KsxsCKcZEL21r_O_8Mn6SM-hOVfMaL1bZKG0YbIpCrqve9HNvlAvlwrbZNV4dA/exec";
        const googleFormUrl = "https://docs.google.com/forms/d/e/1FAIpQLSdFSkvFQSz7N1bhZsjT1aP4mx8WSc5-jJ-eiz6NuSM4Ev6YkA/viewform";

        try {
            await liff.init({ liffId: myLiffId });

            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                const profile = await liff.getProfile();
                const userId = profile.userId;

                // 1. ส่งข้อมูลไปบันทึกที่ Google Sheets แบบเบื้องหลัง (Background)
                // เราใช้ mode: 'no-cors' เพื่อไม่ให้ติดปัญหาเรื่องความปลอดภัยเวลาส่งข้ามโดเมน
                fetch(`${scriptUrl}?uid=${userId}`, { mode: 'no-cors' });

                // 2. รอแวบเดียวแล้วส่ง User ไปที่ Google Form
                // เรายังคงแนบ ID ไปในฟอร์มด้วยเพื่อให้ข้อมูลในฟอร์มกับใน Sheet ตรงกัน
                const finalFormUrl = `${googleFormUrl}?entry.806847352=${userId}`;
                
                setTimeout(() => {
                    window.location.replace(finalFormUrl);
                }, 500); // หน่วงเวลา 0.5 วินาทีเพื่อให้แน่ใจว่า fetch ทำงานทัน
            }
        } catch (err) {
            console.error(err);
        }
    }
    main();
</script>
